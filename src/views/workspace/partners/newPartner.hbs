<link rel="stylesheet" href="/style/new.css">

<div class="New">

    <!-- TODO TITTLE FLAG NEW `PARTNER` -->
    <div class="New-title">
        <h1 class="New-h1">Add New Partner</h1>
    </div>
    <div class="New-flag"></div>

    <!-- TODO FORMULARIO DE AÑADIR NUEVO PARTNER -->
    <form class="New-form" id="formAddPartner" id="formAddPartner">

        {{> formPartner}}

        <div class="Input-button">
            <input class="Button-cancel" onClick="cerrar()" id="btnCancel"
                type="button" value='CANCEL' tabindex="10" />
            <input class="Button-accept" id="btnAccept" type="submit"
                value='ACCEPT' tabindex="11" />
        </div>

    </form>    

</div>

<script defer src="/scripts/partners.js"></script>

<script defer>
    const formAddPartner = document.getElementById("formAddPartner");
    const inputDni = document.getElementById("inputDni");
    const inputName = document.getElementById("inputName");
    
    function cerrar() {
        window.location.href = "/workspace/partners";
    }

    // TODO VALIDAR SI ES MENOR
    try {
        inputDniCheck.addEventListener("change", () => {
            activeSelectDniFamily();
        });
    }
    catch(error){}

    //TODO MESSAGE
    async function responseAddPartner(data) {
        const success = data.success;
        if (success) {
            Swal.fire({
            icon: "success",
            title: "Success",
            text: data.messageSuccess,
            backdrop: "#2C3333",
            timer: 5000,
            showCancelButton: false,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#474E68",
            confirmButtonText: "OK",
            showClass: {
                popup: "animate__animated animate__fadeInDown"
            },
            hideClass: {
                popup: "animate__animated animate__fadeOutUp"
            }
            }).then(response => {
            $("#selectDni").html("");
            formAddPartner.reset();
            familyLink.classList.remove("isEnable");
            inputDni.focus();
            });
        } else {
            Swal.fire({
            icon: "error",
            title: "Oops...",
            text: data.errorMessage,
            backdrop: "#2C3333",
            timer: 5000,
            showCancelButton: false,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#474E68",
            confirmButtonText: "OK",
            showClass: {
                popup: "animate__animated animate__fadeInDown"
            },
            hideClass: {
                popup: "animate__animated animate__fadeOutUp"
            }
            }).then(() => {
            inputDni.focus();
            inputDni.select();
            });
        }
    }

    //TODO ✅ ADD
    async function addNewPartner(data) {
        let idPartner = data.idPartnerFamily;
        console.log({idPartner});
        const url = `/api/partners/add/${idPartner}`;
        fetch(url, {
            method: "POST",
            body: JSON.stringify(data),
            headers: {
            "Content-type": "application/json; charset=UTF-8"
            }
        })
            .then(response => response.json())
            .then(data => responseAddPartner(data))
            .catch(error => console.error(error));
    }

    // TODO ✅ VALIDAR FORMS
    async function correctForms(e) {
        e.preventDefault();
        const index = selectDni.selectedIndex;
        let actualDate = new Date();
        let date = moment(actualDate).format("YYYY-MM-DD");
        let data = {
            inputDni: $.trim($("#inputDni").val()),
            inputName: $.trim($("#inputName").val()),
            inputScanner: $.trim($("#inputScanner").val()),
            inputLastname: $.trim($("#inputLastname").val()),
            inputDirection: $.trim($("#inputDirection").val()),
            inputPopulation: $.trim($("#inputPopulation").val()),
            inputPhone: $.trim($("#inputPhone").val()),
            inputPhoneLandline: $.trim($("#inputPhoneLandline").val()),
            inputEmail: $.trim($("#inputEmail").val()),
            actualDate: date
        };
        if (inputDniCheck.checked) {
            if (index === -1 || index === undefined) return;
            if (index === 0) {
                window.alert("Please select a DNI, to add to your partner list.");
                return;
            }
            const opcionSeleccionada = selectDni.options[index];
            console.log(" <==> ", opcionSeleccionada, " <==> ");
            let idPartnerFamily = opcionSeleccionada.value;
            let dniFamily = opcionSeleccionada.text;
            data.idPartnerFamily = idPartnerFamily;
            data.dniFamily = dniFamily;
            addNewPartner(data);
            selectDni.focus();
        } else {
            let idPartnerFamily = null;
            let dniFamily = null;
            data.idPartnerFamily = idPartnerFamily;
            data.dniFamily = dniFamily;
            addNewPartner(data);
        }
    }

    // TODO EVENTO AL ENVIAR FORMULARIO
    try {
        document.addEventListener("DOMContentLoaded", function () {
            formAddPartner.addEventListener("submit", correctForms);
        });
    } catch(error) {}
</script>