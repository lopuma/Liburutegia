<link href="/style/styleBooks/infoBook.css" rel="stylesheet" />

{{> modalEditBook}}

<div class="Info-contenedor" id="stateInfoBook">
    {{#each book}}
        <script>
            var _BOOKID = {{this.bookID}};
            var _RATING = {{#if this.rating}}{{this.rating}}{{else}}0{{/if}};
        </script>
    {{/each}}
    <div class="Info-header">
        <div class="Info-cover">    
            <div class="Cover-upload Upload" >
                <form action="/api/books/frontPage" enctype="multipart/form-data" method="post">
                    <!--<div class="Upload-group" id="imgBox" style="background-image: url('/img/covers/{{this.cover}}')"> -->
                    <div class="Upload-group" id="imgBox">
                        <input type="file" class="Upload-file" name="coverImage" accept="image/*" id="coverImage" onchange="loadFile(event)">
                        <label for="coverImage" class="Upload-icon"><i class="fa-solid fa-cloud-arrow-up"></i></label>
                    </div>
                    <label id="successUpload"></label>
                    <div class="New-boxes" id="newBoxesID" hidden>
                        <div class="Input-box">
                            <div class="Box-animation Animation">
                                <div class="Box">
                                    {{#each book}}
                                        <input type="text" class="Animation-input form-control" id="bookCoverID" name="idBook" value={{this.bookID}}>
                                        <label class="Animation-label" for="idBook">Number of Book ID *</label>
                                    {{/each}}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="Upload-btn">
                        <input type="submit" value="Save Cover !" class="btn btn-dark">            
                    </div>
                </form>
            </div>
        </div>
        <div class="Info-contents Contents">
            <div class="Contents-data">
                {{#each book}}
                    <div class="Contents-information Information">
                        <div class="Information-title Title">
                            <i class="Title-i fa-solid fa-book-open"></i>
                            <h1 class="Title-h1">
                                {{this.title}}
                            </h1>
                        </div>
                        <div class="Information-author Author">
                            <label>by <span>{{this.author}}</span></label>
                        </div>
                        <h2 class="Information-subtitle">Bibliographic Record</h2>
                        <hr>
                        <!-- TODO BOOK ID -->
                        <div class="Information-boxes">
                            <div class="Information-row">
                                <h3 class="Information-h3">
                                    Book ID:
                                </h3>
                            </div>
                            <div class="Information-cell">
                                <span class="Information-span">
                                    {{this.bookID}}
                                </span>
                            </div>
                        </div>
                        <!-- TODO FECHA COMPRA -->
                        <div class="Information-boxes">
                            <div class="Information-row">
                                <h3 class="Information-h3">
                                    Date of purchase:
                                </h3>
                            </div>
                            <div class="Information-cell">
                                <span class="Information-span">
                                    {{this.purchase_date}}
                                </span>
                            </div>
                        </div>
                        <!-- TODO ISBN -->
                        <div class="Information-boxes">
                            <div class="Information-row">
                                <h3 class="Information-h3">
                                    Print ISBN:
                                </h3>
                            </div>
                            <div class="Information-cell">
                                <span class="Information-span">
                                    {{this.isbn}}
                                </span>
                            </div>
                        </div>
                        <details class="Information-details">
                            <summary class="Information-summary"><dfn>....more details<dfn></summary>
                            <!-- TODO COLLECTION -->
                            <div class="Information-boxes">
                                <div class="Information-row">
                                    <h3 class="Information-h3">
                                        Collection:
                                    </h3>
                                </div>
                                <div class="Information-cell">
                                    <span class="Information-span">
                                        {{this.collection}}
                                    </span>
                                </div>
                            </div>
                            <!-- TODO FECHA TYPE -->
                            <div class="Information-boxes">
                                <div class="Information-row">
                                    <h3 class="Information-h3">
                                        Category:
                                    </h3>
                                </div>
                                <div class="Information-cell">
                                    <span class="Information-span">
                                        {{this.type}}
                                    </span>
                                </div>
                            </div>
                            <!-- TODO FECHA LANGUAGE -->
                            <div class="Information-boxes">
                                <div class="Information-row">
                                    <h3 class="Information-h3">
                                        Language:
                                    </h3>
                                </div>
                                <div class="Information-cell">
                                    <span class="Information-span">
                                        {{this.language}}
                                    </span>
                                </div>
                            </div>
                            <!-- TODO FECHA OBSERVATIONS -->
                            <div class="Information-boxes">
                                <div class="Information-row">
                                    <h3 class="Information-h3">
                                        Observations:
                                    </h3>
                                </div>
                                <div class="Information-cell isObservation">
                                    <span class="Information-span">
                                        {{this.observation}}
                                    </span>
                                </div>
                            </div>
                        </details>
                    </div>
                    <div class="Contents-totalReview Review">
                        <h3>CUSTOMER REVIEWS</h3>
                        <hr>
                        <div class="Review-header">
                            <div class="Review-star">
                                <div class="stars-outer">
                                    <div class="stars-inner" id="totalScore" style="cursor: pointer" title="Total score {{this.rating}} star">
                                    </div>
                                </div>
                                <span>{{#if this.rating}}{{this.rating}} of 5{{else}}0 of 5{{/if}}</span>
                            </div>
                            <div class="Review-lastupdate Update">
                                <i class="fa-regular fa-pen-to-square"></i><span class="Update-span">Last Update </span><strong>{{this.lastUpdate}}</strong>
                            </div>
                            <div class="Review-total">
                                <i class="fa-solid fa-chart-line"></i> <a href="#customerReviews"><span class="Review-span">{{this.numVotes}} Overall Ratings</span></a>
                            </div>
                            <div class="Review-reserved">
                                {{#if this.reserved}}                                
                                    <i class="fa-solid fa-book"></i> The book is  <span class="badge rounded-pill bg-warning text-dark" style="cursor: pointer; color: black; font-size: 1em">Not available</span>
                                {{else}}
                                    <i class="fa-solid fa-book"></i> The book is  <span class="badge rounded-pill bg-success" style="cursor: pointer; font-size: 1em">Available</span>
                                {{/if}}
                            </div>
                        </div>
                        <h3>ACTIONS</h3>
                        <hr>
                        <div class="Review-actions">
                            <button id="btnEditBook" onClick=_editBook({{this.bookID}}) type="button" class="Action-btn btn btn-outline-info" title="Edit Book" data-toggle="modal" data-target="#modalEditBook" href="#edit"><i class="fa-regular fa-pen-to-square"></i> Edit Information</button>
                            {{#unless this.reserved}}
                                <button id="btnReserveBook" onClick=reserveBook({{this.bookID}}) class="Action-btn btn btn-secondary" title="Reserve a Book"><i class="fa-solid fa-calendar-days"></i> Reserve a Book</button>
                            {{/unless}}
                            <button id="btnDeleteBook" class="Action-btn isDelete btn btn-danger" onClick=deleteBook({{this.bookID}})  type="button">Delete</button>
                        </div>
                    </div>
                    
                {{/each}}
            </div>
        </div>
    </div>
    <div class="Info-container Container" name="customerReviews" id="customerReviews">
        <div class="Container-header">
            <i class="Container-i fa-solid fa-message"></i>
            <span class="Container-span">Reviews</span>
        </div>
        <hr class="Container-hr">
        <div class="Container-review" id="containerReview">

        </div>
    </div>
</div>

<script defer src="/scripts/Globals/funcGlobals.js" type="text/javascript"></script>

<script defer type="text/javascript">

    const imgBox = document.getElementById('imgBox');
    const btnEditBook = document.getElementById('btnEditBook');
    const btnReserveBook = document.getElementById('btnReserveBook');
    const btnDeletetBook = document.getElementById('btnDeletetBook');
    const containerReview =  document.getElementById('containerReview');

//TODO ✅ ACTIVAR CHECK SI ESTA ACTIVA VENTANA BOOK
    try {
        if ($('#stateInfoBook').val() === '') { // 
            _STATEINFOBOOK = true;
        }
    } catch (error) { }

    // TODO ✅ FUNCTION PARA MOSTRAR EL PORCENTAJE DE ESTRELLAS
    function obtenerPorcentaje(_RATING_) {
        const starPercentage = _RATING_ / 5 * 100;
        const starPercentageRounded = `${Math.round(starPercentage / 10) * 10}%`;
        return starPercentageRounded;
    }

    // TODO ✅ AÑADIR TOTAL SCORE AL LIBRO
    try{
        document.getElementById('totalScore').style.width = obtenerPorcentaje(_RATING);
    } catch (error) { }

    //TODO ✅ ASIGNAR COVER AL LIBRO
    try{ 
        const urlBook = `/workspace/books/infoCover/${_BOOKID}`
        fetch(urlBook)
            .then((resp) => resp.json())
            .then(function(data) {
                let nameCover = data[0].cover;
                if(nameCover !== null) {
                    imgBox.style.backgroundImage = `url(/img/covers/${nameCover})`;
                } else {
                    imgBox.style.backgroundImage = `url(/img/covers/default-image.png)`;
                }
            })
            .catch(function(error) {
                console.error(error);
            });

        var loadFile = (event) => {
            imgBox.style.backgroundImage = "url(" + URL.createObjectURL(event.target.files[0]) + ")";
        };
    } catch (error) { }

    // TODO ✅ EDITAR LIBRO
    async function _editBook(idBook) {
        opcion = 'edit';
        const bookID = idBook;
        await globalEditBook(bookID);
    }

    // TODO ✅ RESERVAR LIBRO
    async function reserveBook(idBook){
        const bookID = idBook;
        console.log(bookID);
    }

    // TODO ✅ ELIMNAR LIBRO
    async function deleteBook(idBook){
        const bookID = idBook;
        globalDeleteBook(bookID);
    }

    // TODO ✅ FUNCION AUTOEJECUTABLE PARA EXTRAER LOS REVIEWS
    (async ( ) => {
        const bookID = _BOOKID;
        const urlReviews = `/api/books/info/reviews/${bookID}` 
        fetch(urlReviews, {
            method: "GET",
            headers: {
                "Content-type": "application/json; charset=UTF-8"
            }
        })
            .then((response) => response.json())
            .then((data) => createCardReview(data));
    }) ( )
    function generarNuevoColor(){
        var simbolos, color;
        simbolos = "0123456789ABCDEF";
        color = "#";

        for(var i = 0; i < 6; i++){
            color = color + simbolos[Math.floor(Math.random() * 16)];
        }

        return color;
    }
    async function createCardReview(data){
        try {
            if(data.success) {
                const reviws = data.data;
                let valores = Object.values(reviws); //
                let textRate = "";
                let colorStar = "";
                let textShadow = "";
                for(let i=0; i< valores.length; i++){
                    const color = generarNuevoColor();
                    const score = obtenerPorcentaje(valores[i].score);
                    const dateReview = moment(valores[i].dateReview).format("MMMM Do, YYYY HH:mm A");
                    const review = valores[i].review;
                    const fullName = valores[i].fullName;
                    if(score === "100%") {
                        textRate =  "I'm lovin it ";
                        colorStar = "#fe7";
                        textShadow = "0 0 10px #006E7F";
                        
                    } else if(score === '80%') {
                        textRate =  "I like it! ";
                    } else if(score === '60%') {
                        textRate =  "Alright! ";
                    } else if(score === '40%') {
                        textRate =  "i like little ";
                    } else {
                        textRate =  "I don't like it ";
                    }
                    template  = `
                        <div class='Review-box'>
                            <div class='Review-name'>
                                <div class='Review-icon'>
                                    <i class='fa-solid fa-circle-user' style='color: ${color}'></i><br>
                                </div>
                                <div class='Review-fullname'>${fullName}</div>
                            </div>
                            <div class='Review-dateReview'>
                                <span class='Review-date'>Revised on ${dateReview}</span>
                            </div>
                            <div class='Review-content'>
                                <div class='Review-score'>
                                    <div class='stars-outer'>
                                        <div class='stars-inner' id='totalScore' style='width: ${score}' title='Total score ${valores[i].score} star'>
                                        </div>
                                    </div>
                                    <div class='Review-rate'>
                                        ${textRate}
                                    </div>
                                </div>
                                <div class='Review-message'>${review}</div>
                            </div>
                        </div>
                    `;
                    containerReview.innerHTML += template;
                }
            } else { 
                template = `<h2 class="linea"><span>There are currently no reviews</span></h2>`;
                containerReview.innerHTML = template;
            }
        } catch (error) { }
    }

</script>